#
# Generated by Chef
#
# Based on the 10gen official upstart script

# handled by the limits cookbook
# set at user-level
# limit nofile 20000 20000

kill timeout <%= node[:mongodb][:server][:timeout] %>

<%
  @config = node[:mongodb][@server_type]
  @binary = @server_type == :mongos ? 'mongos' : 'mongod'
%>

pre-start script
  <% @config
  mkdir -p <%= @config[:dbpath] %>
  chown -R mongodb:mongodb <%= @config[:dbpath] %>
  mkdir -p <%= @config[:logpath] %>
  chown -R mongodb:mongodb <%= @config[:logpath] %>
end script

start on runlevel [2345]
stop on runlevel [06]

script
  ENABLE_MONGODB="yes"

  DAEMON=/usr/bin/<%= @binary %>
  NAME=<%= @server_type %>

  # Default defaults. Can be overridden by the /etc/default/$NAME
  CONF=<%= @config[:config] %>
  PIDFILE=<%= @config[:pidfile] %>

  <% case @server_type; when 'config_server' %>
  CONFIGSVR=--configsvr
  <% when 'mongos' %>
  CONFIGDB="--configdb <%= @configdb_server_list %>"
  <% else %>
  REPLSET=<%= @config[:replSet] %>
  SHARDSVR=<%= @config[:shardsvr] %>
  <% end %>

  <% unless @server_type == 'mongos' %>
  REST=<%= @config[:rest] %>
  SYNCDELAY="--syncdelay <%= @config[:syncdelay] %>"
  <% end %>

  if [ -f /etc/default/$NAME ]; then . /etc/default/$NAME; fi

  # Check for daemon bin
  if test ! -x $DAEMON; then
    echo "Could not find $DAEMON"
    exit 0
  fi

  # This will enable the REST Interface for MongoDB if told so
  if test "x$REST" = "xtrue"; then
    REST=--rest
  else
    REST=
  fi

  # This will make the server part of a replica set
  if test "x$REPLSET" = "x"; then
    REPLSET=
  else
    REPLSET="--replSet $REPLSET"
  fi

  # This will make the server participate in sharding
  if test "x$SHARDSVR" = "xtrue"; then
    SHARDSVR=--shardsvr
  else
    SHARDSVR=
  fi

  if [ "x$ENABLE_MONGODB" = "xyes" ]; then exec start-stop-daemon --start --quiet --chuid mongodb --exec $DAEMON -- $REST $REPLSET $SHARDSVR $CONFIGSVR $SYNCDELAY $CONFIGDB --config $CONF; fi
end script

